# models/staging/shopify/stg_shopify__customers.yml
version: 2

models:
  - name: stg_shopify__customers
    description: >
      Staging model for Shopify customers with standardized naming and derived fields.
      
      **Source:** Shopify customers table
      
      **Grain:** One row per customer
      
      **Primary Key:** customer_id
      
      **Transformations applied:**
      - Renamed columns for consistency (prefix with customer_)
      - Created full_name from first and last name
      - Generated surrogate key for deduplication scenarios
      - Standardized timestamp column naming
    
    config:
      tags: ['staging', 'shopify', 'daily', 'pii']
      
    columns:
      - name: customer_id
        description: "{{ doc('customer_id') }}"
        tests:
          - unique
          - not_null
      
      - name: customer_email
        description: Customer email address (PII - handle with care)
        tests:
          - not_null
          
      - name: first_name
        description: Customer first name (PII)
        tests:
          - not_null
          
      - name: last_name
        description: Customer last name (PII)
        tests:
          - not_null
          
      - name: full_name
        description: Concatenated full name (first + last)
        tests:
          - not_null
          
      - name: customer_unique_key
        description: Surrogate key combining first_name, last_name, and email for deduplication
        tests:
          - unique
          - not_null
          
      - name: customer_country
        description: Customer country of residence
        tests:
          - accepted_values:
              name : accepted_values_stg_shopify_customer_country
              values: ['France', 'Germany', 'Spain', 'Italy', 'Belgium', 
                       'Netherlands', 'UK', 'Switzerland']
              quote: true
          - not_null
          
      - name: customer_created_at
        description: Timestamp when customer account was created in Shopify
        tests:
          - not_null
          
      - name: customer_updated_at
        description: Timestamp when customer record was last modified
        
      - name: loaded_at_timestamp
        description: Timestamp when data was loaded to Snowflake from source

# ============================================
  # STG_SHOPIFY__ORDERS
  # ============================================
  - name: stg_shopify__orders
    description: >
      Staging model for Shopify orders with business logic transformations.
      
      **Source:** Shopify orders table
      
      **Grain:** One row per order
      
      **Primary Key:** order_id
      
      **Business Logic:**
      - Revenue only counted for completed orders
      - Refunds tracked separately with absolute values
      - Orders categorized by size for analysis
      - Boolean flags for each status state
    
    config:
      tags: ['staging', 'shopify', 'daily']
    
    tests:
    {#   # Custom test: order_date should be after customer creation
      - dbt_utils.expression_is_true:
          expression: "order_date >= (select min(customer_created_at) from {{ ref('stg_shopify__customers') }})"
          config:
            severity: warn #}
    
    columns:
      - name: order_id
        description: Unique identifier for each order (primary key)
        tests:
          - unique
          - not_null
          
      - name: customer_id
        description: Foreign key to customers table
        tests:
          - not_null
          - relationships:
              to: ref('stg_shopify__customers')
              field: customer_id
              config:
                severity: error
                error_if: ">100"  # Allow some orphaned orders, but not too many
          
      - name: order_date
        description: Timestamp when order was placed (UTC timezone)
        tests:
          - not_null
          
      - name: order_status
        description: Current status of the order
        tests:
          - accepted_values:
              values: ['pending', 'completed', 'cancelled', 'refunded']
              quote: true
          - not_null
          
      - name: order_total
        description: >
          Total order amount in EUR.
          Can be negative for refunded orders.
        tests:
          - not_null
          
      - name: is_completed
        description: Boolean flag indicating if order is completed
        tests:
          - accepted_values:
              values: [true, false]
              
      - name: is_cancelled
        description: Boolean flag indicating if order was cancelled
        
      - name: is_refunded
        description: Boolean flag indicating if order was refunded
        
      - name: is_pending
        description: Boolean flag indicating if order is pending
        
      - name: order_revenue
        description: >
          Revenue amount (only for completed orders, 0 otherwise).
          Used for revenue calculations in downstream models.
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
              config:
                severity: error
          
      - name: refund_amount
        description: >
          Absolute value of refund (only for refunded orders, 0 otherwise).
          Always positive for accounting clarity.
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
              
      - name: order_size_category
        description: Order value category (small, medium, large, very_large)
        tests:
          - accepted_values:
              values: ['small', 'medium', 'large', 'very_large']
              quote: true
          - not_null
          
      - name: order_created_at
        description: Timestamp when order record was created
        tests:
          - not_null
          
      - name: order_updated_at
        description: Timestamp when order was last modified
        tests:
          - not_null
          
      - name: loaded_at_timestamp
        description: Timestamp when data was loaded to Snowflake
# models/staging/google_analytics/stg_google_analytics.yml
version: 2

models:
  - name: stg_google_analytics__sessions
    description: >
      Staging model for Google Analytics session data with engagement metrics.
      
      **Source:** Google Analytics sessions table
      
      **Grain:** One row per session
      
      **Primary Key:** session_id
      
      **Key Metrics:**
      - Engagement level: bounce, low, medium, high
      - Traffic channels: organic, paid, direct, referral, social
      - Time-based aggregations: day, week, month
    
    config:
      tags: ['staging', 'google_analytics', 'daily', 'web_analytics']
    
    tests:
      # Custom test: session_duration should be >= page_views * 5 seconds minimum
      - dbt_utils.expression_is_true:
          expression: "session_duration_seconds >= (page_views * 5) or page_views = 1"
          config:
            severity: warn
            warn_if: ">500"  # Warn if more than 500 sessions violate this
    
    columns:
      - name: session_id
        description: Unique identifier for each session
        tests:
          - unique
          - not_null
          
      - name: user_id
        description: Anonymous user identifier (cookie-based, not PII)
        tests:
          - not_null
          
      - name: session_date
        description: Timestamp when session started (UTC)
        tests:
          - not_null
          
      - name: session_date_day
        description: Date of session (truncated to day)
        tests:
          - not_null
          
      - name: session_date_week
        description: Week of session (Monday start)
        
      - name: session_date_month
        description: Month of session
        
      - name: page_views
        description: Number of pages viewed during session
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 1"
              config:
                severity: error
          
      - name: session_duration_seconds
        description: Total duration of session in seconds
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
          
      - name: session_duration_minutes
        description: Session duration converted to minutes (rounded to 2 decimals)
        tests:
          - not_null
          
      - name: avg_time_per_page_seconds
        description: >
          Average time spent per page view.
          Calculated as session_duration / page_views.
          Returns 0 for very short sessions to avoid skewing.
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
          
      - name: engagement_level
        description: >
          Categorized engagement level:
          - bounce: 1 page, <30s
          - low_engagement: <=3 pages, <60s
          - medium_engagement: <=7 pages, <5min
          - high_engagement: >7 pages or >5min
        tests:
          - accepted_values:
              values: ['bounce', 'low_engagement', 'medium_engagement', 'high_engagement']
              quote: true
          - not_null
          
      - name: is_bounce
        description: Boolean flag for bounced sessions (1 page, <30s)
        tests:
          - accepted_values:
              values: [true, false]
          - not_null
          
      - name: is_engaged_session
        description: Boolean flag for engaged sessions (5+ pages OR 3+ minutes)
        tests:
          - accepted_values:
              values: [true, false]
          - not_null
          
      - name: traffic_source
        description: Traffic source (lowercase normalized)
        tests:
          - not_null
          - accepted_values:
              values: ['organic', 'paid', 'direct', 'referral', 'social']
              quote: true
          
      - name: traffic_medium
        description: Traffic medium (lowercase normalized)
        
      - name: campaign_name
        description: Campaign name (for paid traffic)
        
      - name: traffic_channel
        description: Grouped traffic channel for analysis
        tests:
          - accepted_values:
              values: ['organic_search', 'paid_advertising', 'direct_traffic', 
                       'referral_traffic', 'social_media', 'other']
              quote: true
          - not_null
          
      - name: is_paid_traffic
        description: Boolean flag for paid traffic sources
        tests:
          - accepted_values:
              values: [true, false]
          - not_null
          
      - name: is_organic_traffic
        description: Boolean flag for organic traffic sources
        tests:
          - accepted_values:
              values: [true, false]
          - not_null
          
      - name: loaded_at_timestamp
        description: Timestamp when data was loaded to Snowflake